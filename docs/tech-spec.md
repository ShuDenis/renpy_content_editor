# Tech Spec: Система редактирования и генерации сцен Ren’Py

## 1. Назначение

Проект состоит из двух частей:

1. **Редактор сцен** (отдельное приложение)

   - Позволяет создавать и редактировать сцены для игры в визуальном виде.
   - Сохраняет данные в формате **JSON** по согласованным шаблонам.
   - Шаблон можно расширять, чтобы поддерживать новые возможности Ren’Py.

2. **Генератор** (утилита `SceneGen`)

   - Принимает на вход JSON-файл.
   - Валидирует его структуру и значения.
   - Генерирует готовые `.rpy`-файлы для использования в игре.

---

## 2. Архитектура

```
[Редактор сцен]
   ↓ (экспорт JSON)
[scene_data.json]
   ↓ (валидация + генерация)
[SceneGen]
   ↓
[.rpy файлы в /game/_gen/]
   ↓
[Ren’Py] → компиляция в .rpyc → запуск игры
```

- **Редактор** — не связан напрямую с Ren’Py, весь обмен идёт через JSON.
- **Генератор** — отдельная Python-утилита (без зависимостей), которую можно запускать вручную или в CI.
- В `.rpy`-файлы не вносятся изменения вручную — они **полностью перезаписываются** при генерации.

---

## 3. Структура JSON-сцены

Пример базового JSON (координаты относительные к `reference_resolution`):

```json
{
  "version": "1.0",
  "project": {
    "reference_resolution": { "width": 1920, "height": 1080 },
    "coords_mode": "relative"
  },
  "scenes": [
    {
      "id": "hall",
      "name": "Коридор",
      "enter_transition": { "type": "fade", "duration": 0.3 },
      "layers": [
        { "id": "bg", "type": "image", "image": "bg/hall_day.png", "zorder": 0 },
        { "id": "overlay", "type": "color", "color": "#000000", "alpha": 0.0, "zorder": 100 }
      ],
      "hotspots": [
        {
          "id": "to_classroom",
          "shape": "rect",
          "rect": { "x": 0.10, "y": 0.15, "w": 0.15, "h": 0.20 },
          "tooltip": "В класс",
          "hover_effect": { "highlight": true, "opacity": 0.12, "border": "dashed" },
          "action": { "type": "go_scene", "scene_id": "classroom", "transition": { "type": "wipeleft", "duration": 0.25 } }
        }
      ]
    }
  ]
}
```

### 3.1. Ключевые поля

- **project.reference\_resolution** — базовое разрешение, на которое нормализуются координаты.
- **coords\_mode** — `"relative"` (0–1) или `"absolute"` (пиксели).
- **scenes[].id** — уникальный идентификатор сцены.
- **layers[]** — слои отрисовки (фон, наложения, группы).
- **hotspots[]** — кликабельные области:
  - `shape`: `"rect"`, `"polygon"`, `"circle"`.
  - `action.type`:
    - `"go_scene"` → переход на другую сцену.
    - `"jump_label"` / `"call_label"` → прямой переход к label.
    - `"call_screen"` → показ экрана.
    - `"function"` → вызов Python-функции.

---

## 4. Процесс генерации `.rpy`

1. **Валидация** (`validator.py`)

   - Проверка обязательных полей.
   - Проверка типов данных.
   - Проверка диапазонов координат (для relative — 0..1).
   - Проверка уникальности `scene.id` и `layer.id`.

2. **Генерация** (`generator.py`)

   - Создание `screen scene_<id>()`:
     - Отрисовка слоёв (`add`, `Solid`, `ConditionSwitch`).
     - Хотспоты как `button` с плашкой/рамкой.
     - `tooltip` через глобальную переменную и отдельный экран.
   - Создание `label show_<id>`:
     - Установка базового фона.
     - Показ экрана сцены и тултипов.
   - Вспомогательный файл `_gen/scene_helpers.rpy`:
     - Экран `scene_tooltip_overlay`.
     - Лейбл `scene__internal__go` для `go_scene`.

---

## 5. Пример сгенерированного `.rpy`

```renpy
# _gen/scene_hall.rpy
screen scene_hall():
    zorder 10
    fixed:
        add "bg/hall_day.png" at Transform(xpos=960, ypos=540, anchor=(0.5, 0.5), zoom=1.0, rotate=0)
    # Hotspots
    button:
        xpos 192 ypos 162 xsize 288 ysize 216
        focus_mask True
        hovered SetField(store, 'scene_tooltip', _(\"В класс\")) unhovered SetField(store, 'scene_tooltip', None)
        action [SetField(store,'_next_scene','classroom'), Jump('scene__internal__go')]
        hovered:
            fixed:
                add Solid('#FFFFFF', xysize (288,26)) alpha 0.12

label show_hall:
    scene bg/hall_day.png with Fade(0.3)
    show screen scene_hall
    show screen scene_tooltip_overlay
    $ renpy.pause(0)
    return
```

---

## 6. Преимущества подхода

- **Быстрое исполнение**: всё компилируется в `.rpyc`, нет парсинга JSON на старте.
- **Простота отладки**: `renpy.lint` видит все сцены и их лейблы.
- **Чистая архитектура**: логика и контент разделены.
- **Масштабируемость**: можно расширять JSON новыми полями без переписывания ядра игры.

---

## 7. План расширений

- Поддержка **viewport/drag** для панорамных сцен.
- Настоящая обработка форм (hit-test для кругов/полигонов).
- Условная видимость слоёв и хотспотов (`visible_if`, `enabled_if`).
- Параллакс для слоёв.
- Визуальные стили хотспотов (цвет, рамка, иконки).
- Связка с другими редакторами (диалоги, предметы, интерактив).

## 8. Дорожная карта разработки

### 8.1. ScenesEditor

- **Многоугольные и круглые хотспоты** с drag&drop и изменением размеров.  
  **TechSpec**: `polygon` хранится как массив точек `{x, y}` (до 32 вершин), `circle` — центр `{x, y}` и `r`. Точки задаются в относительных координатах к `reference_resolution`.
- **UI редактирования свойств хотспотов** (tooltip, action, переходы).  
  **TechSpec**: действия `go_scene`, `jump_label`, `call_label`, `call_screen`, `function`; переходы описываются как `{type, duration, easing?}`; условия в виде `visible_if`, `enabled_if` (выражения на переменных).
- **Управление слоями**: добавление/удаление, настройка изображений и цветов, z-order, переходы.  
  **TechSpec**: слой `{id, type, zorder, source, props, enter_transition, exit_transition}`; типы: `image`, `color`, `group`; поддержка PNG/JPG/WebP, цветовые фильтры, alpha.
- **Превью фонов и быстрый просмотр сцены**.  
  **TechSpec**: рендер на `Canvas` с optional WebGL; кэш изображений LRU в памяти (до 50 MB).
- **Сохранение/загрузка сцен** в браузер (LocalStorage) и импорт/экспорт JSON.  
  **TechSpec**: JSON-формат версии `1.x`; миграции через `schema_version` и конвертер.
- **Вставка изображений**.  
  **TechSpec**: форматы PNG/JPG/WebP; позиционирование через drag&drop; масштабирование с привязкой к границам; минимальная производительность — 60 fps при 10 слоях.
- **Базовая анимация**: параллакс и FX.  
  **TechSpec**: эффекты `offset(x,y)`, `opacity`, `shader` (WebGL); API `{duration, loop, trigger}`.

  **TBD:** максимальное число слоёв, поддержка пользовательских шейдеров, способ хранения easing-функций.

### 8.2. DialogEditor

- **Редактирование текста, спикера и вариантов выбора**.  
  **TechSpec**: текст узла ≤ 2048 символов; ветвления — массив `{id, text, condition?, next}`.
- **Несколько диалогов в проекте** и переключение.  
  **TechSpec**: диалоги идентифицируются по `dialog_id`; ссылки между диалогами через `goto_dialog`.
- **Условия переходов, переменные и проверки графа**.  
  **TechSpec**: переменные типов `bool`, `int`, `str`; валидация Zod; синтаксис условий `var op value`.
- **Drag&drop узлов, масштабирование, undo/redo**.  
  **TechSpec**: история на 50 шагов, хранение диффов; масштаб 25–200 %.
- **Стабильный экспорт JSON**.  
  **TechSpec**: финальная схема `dialog_schema_v1`; версионирование `schema_version`.
- **Портреты и эмоции**.  
  **TechSpec**: `{character_id, emotion}` → путь к спрайту; стандартные эмоции `neutral|happy|sad|angry`; PNG/WebP 512×512.

  **TBD:** нужно ли ограничение по количеству вариантов выбора, поддержка многострочного текста в переходах.

### 8.3. Обратная интеграция с Ren’Py‑проектом

- **Импорт данных**: документации по переменным, списку диалогов и ресурсам.  
  **TechSpec**: путь к проекту задаётся в настройках; парсятся `*.rpy`, `*.json`, `*.rst`.
- **Правила обновления и конфликтов версий**.  
  **TechSpec**: при коллизии предпочитается более новая `schema_version`; журнал изменений ведётся локально.
- **Использование импортированных данных** внутри редакторов.  
  **TechSpec**: API `importCache.getVariables()`, `getDialogs()`; кэш в IndexedDB с TTL 1 день; синхронизация по timestamp.

  **TBD:** механизм отслеживания удаления файлов во внешнем проекте, обработка нестандартных форматов.

### 8.4. Визуал и UX

- **Редизайн интерфейса**: цветовая схема, иконки, типографика.  
  **TechSpec**: гайдлайн в Figma; компоненты на базе React; шрифт Inter, иконки SVG 24 px.
- **Улучшение навигации**: панель проектов, быстрый доступ к сценам/диалогам/персонажам.  
  **TechSpec**: UX‑флоу `projects → scenes/dialogs → editor`; адаптивность ≥ 1024 px (desktop) и ≥ 768 px (tablet).

  **TBD:** поддержка мобильных устройств, ночная/светлая темы.

### 8.5. Расширение функционала (Stage 4–5)

- **Редактор предметов и инвентаря**.  
  **TechSpec**: предмет `{id, name, desc, icon, stack?}`; связь через `scene_id` или `dialog_id`.
- **Утилиты генерации `.rpy`** (`SceneGen`, `DialogGen`, `BranchGen`, `ItemGen`).  
  **TechSpec**: единый формат входа (JSON); общие параметры `--schema-version`, `--output`; индивидуальные опции для генераторов.

  **TBD:** лимиты по количеству предметов, правила наследования параметров генерации.

### 8.6. Редактор персонажей

- **Создание и редактирование персонажей**: имя, цвет, набор спрайтов и эмоций.  
  **TechSpec**: `{id, name, color, sprites:{emotion:path}}`; файлы хранятся в `assets/characters/<id>/<emotion>.png`; локализация через `name_i18n`.
- **Связь персонажей с диалогами и сценами**.  
  **TechSpec**: ссылки по `character_id`; жизненный цикл — удаление только при отсутствии ссылок.

  **TBD:** система тегов/ролей персонажей, поддержка анимационных спрайтов.

### 8.7. Интеграция и тестирование

- **Python‑скрипты генерации `.rpy`** из JSON.  
  **TechSpec**: Python 3.11, Ren’Py 8.1; отчёты об ошибках в формате JSON (`{level, msg, file, line}`).
- **Автоматические проверки схем и unit‑тесты**.  
  **TechSpec**: CI на GitHub Actions; проверки Zod + JSON Schema; минимальные тесты: валидация JSON, генерация `.rpy`, smoke‑test.
- **Документация** по запуску, контрибьютингу и архитектуре.  
  **TechSpec**: разделы `getting-started`, `architecture`, `contributing`; примеры минимальных сцен/диалогов.

  **TBD:** набор целевых платформ для CI, объём тестового покрытия.

